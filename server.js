const express = require('express');
const { Client } = require('pg');
const app = express();
const port = process.env.PORT || 5000;

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… PostgreSQL
const client = new Client({
    connectionString: process.env.DATABASE_URL,
    ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,
});

// ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
client.connect()
    .then(() => console.log('âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… PostgreSQL'))
    .catch(err => console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', err));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ ÑÐµÑ€Ð²ÐµÑ€Ð°
client.query(`
    CREATE TABLE IF NOT EXISTS scores (
        user_id TEXT PRIMARY KEY,
        username TEXT DEFAULT 'Unknown',
        best_score INTEGER DEFAULT 0
    )
`).then(() => console.log("ðŸ†• Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° 'scores' ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð°."))
  .catch(err => console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹:", err));

// ðŸš¦ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
app.get('/api/user_score/:telegramUserId', async (req, res) => {
    const userId = req.params.telegramUserId;
    try {
        const result = await client.query('SELECT best_score FROM scores WHERE user_id = $1', [userId]);
        res.json({ best_score: result.rows.length > 0 ? result.rows[0].best_score : 0 });
    } catch (err) {
        console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°:', err);
        res.status(500).json({ error: 'Database error' });
    }
});

// ðŸš€ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ€ÐµÐºÐ¾Ñ€Ð´Ð°
app.post('/api/score', async (req, res) => {
    const { user_id, username, score } = req.body;
    if (!user_id || !username || typeof score === 'undefined') {
        return res.status(400).json({ error: 'Missing user_id, username, or score' });
    }

    try {
        await client.query(`
            INSERT INTO scores (user_id, username, best_score)
            VALUES ($1, $2, $3)
            ON CONFLICT (user_id) DO UPDATE 
            SET best_score = GREATEST(scores.best_score, $3), username = $2
        `, [user_id, username, score]);

        res.json({ success: true });
    } catch (err) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ð¸ Ñ€ÐµÐºÐ¾Ñ€Ð´Ð°:", err);
        res.status(500).json({ error: 'Database error' });
    }
});

// ðŸ“ˆ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð»Ð¸Ð´ÐµÑ€Ð¾Ð² (Ñ‚Ð¾Ð¿-10 Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²)
app.get('/api/leaderboard', async (req, res) => {
    try {
        const result = await client.query('SELECT user_id, username, best_score FROM scores ORDER BY best_score DESC LIMIT 10');
        const leaderboard = result.rows.map((row, index) => ({
            position: index + 1,
            user_id: row.user_id,
            username: row.username,
            score: row.best_score
        }));
        res.json(leaderboard);
    } catch (err) {
        console.error("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð»Ð¸Ð´ÐµÑ€Ð¾Ð²:", err);
        res.status(500).json({ error: 'Database error' });
    }
});

app.listen(port, () => {
    console.log(`ðŸš€ Ð¡ÐµÑ€Ð²ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð½Ð° Ð¿Ð¾Ñ€Ñ‚Ñƒ ${port}`);
});
